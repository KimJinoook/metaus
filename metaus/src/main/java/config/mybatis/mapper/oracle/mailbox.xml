<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.metaus.mailbox.model.MailboxDAO">
	<insert id="insertMailbox" parameterType="mailboxVo">
		<selectKey resultType="int" keyProperty="msgNo" order="BEFORE">
			select FP_MSG_SEQ.nextval from dual
		</selectKey>
		
		insert into fp_msg(msg_no, msg_title, msgadd_adser, msg_content)
		values(#{msgNo}, #{msgTitle}, #{msgaddAdser}, #{msgContent})
	</insert>
	
	<select id="selectMsgNo" resultType="int">
		select msg_no from fp_msg
		where rownum=1 order by msg_no desc
	</select>
	
	<insert id="insertRecipient" parameterType="RecipientVO">
		<selectKey resultType="int" keyProperty="msgaddNo" order="BEFORE">
			select fp_msgadd_SEQ.nextval from dual
		</selectKey>
		
		insert into fp_msgadd(msgadd_no, msg_no, msgadd_adsee)
		values(#{msgaddNo}, #{msgNo}, #{msgaddAdsee})
	</insert>
	
	<!-- ORACLE의 CLOB 타입의 데이터는 MyBatis를 이용해 처리할 때는 resultMap을 통해 타입 지정을 해야 함 -->
	<!-- selectMsgViewBySender -->
	<resultMap id="getMsgViewBySender" type="HashMap">
		<result property="MSG_CONTENT" column="MSG_CONTENT" jdbcType="CLOB" javaType="java.lang.String" />
	</resultMap>
	
	<select id="selectMsgViewBySender" parameterType="string" resultMap="getMsgViewBySender">
		select * from msgview
		where msgadd_adser=#{msgaddAdser} order by msg_no desc
	</select>
	
	<!-- selectMsgViewByRecipient -->
	<resultMap id="getMsgViewByRecipient" type="HashMap">
		<result property="MSG_CONTENT" column="MSG_CONTENT" jdbcType="CLOB" javaType="java.lang.String" />
	</resultMap>
	
	<select id="selectMsgViewByRecipient" parameterType="string" resultMap="getMsgViewByRecipient">
		select * from msgview
		where msgadd_adsee=#{msgaddAdsee} order by msg_no desc
	</select>
	
	<!-- selectMsgViewByStar -->
	<resultMap id="getMsgViewByStar" type="HashMap">
		<result property="MSG_CONTENT" column="MSG_CONTENT" jdbcType="CLOB" javaType="java.lang.String" />
	</resultMap>
	
	<select id="selectMsgViewByStar" parameterType="string" resultMap="getMsgViewByStar">
		select *
		from
		(
		    select * from msgview
		    where msgadd_adsee=#{memId} or msgadd_adser=#{memId}
		    order by msg_no desc
		)
		where star_flag='Y'
		order by msg_no desc
	</select>
	
	<!-- selectByMsgAddNo -->
	<resultMap id="getByMsgAddNo" type="HashMap">
		<result property="MSG_CONTENT" column="MSG_CONTENT" jdbcType="CLOB" javaType="java.lang.String" />
	</resultMap>
	
	<select id="selectByMsgAddNo" parameterType="int" resultMap="getByMsgAddNo">
		select * from msgview
		where msgadd_no=#{msgadd_no}
	</select>
	
	<insert id="insertMailboxAtc" parameterType="mailboxAtcVo">
		<selectKey resultType="int" keyProperty="mfileNo" order="BEFORE">
			select fp_msgatc_seq.nextval from dual
		</selectKey>
		insert into fp_msgatc
		values(#{mfileNo}, #{msgNo}, #{mfileFilename}, #{mfileOriginname}, #{mfileFilesize})
	</insert>
	
	<select id="findReceivedNo" parameterType="string" resultType="int">
		select count(*) from msgView
		where msgadd_adsee=#{msgaddAdsee}
	</select>
	
	<select id="findSentNo" parameterType="string" resultType="int">
		select count(*) from msgView
		where msgadd_adser=#{msgaddAdser}
	</select>
	
	<select id="findStarNo" parameterType="string" resultType="int">
		select count(*) from msgView
		where msgadd_adser=#{msgaddAdser} and star_flag='Y'
	</select>
	
	<select id="findTemporaryNo" parameterType="string" resultType="int">
		select count(*) from msgView
		where msgadd_adser=#{msgaddAdser} and temporary_flag='Y'
	</select>
	
	<select id="findSpamNo" parameterType="string" resultType="int">
		select count(*) from msgView
		where msgadd_adser=#{msgaddAdser} and spam_flag='Y'
	</select>
	
	<select id="findTrashNo" parameterType="string" resultType="int">
		select count(*) from msgView
		where msgadd_adser=#{msgaddAdser} and trash_flag='Y'
	</select>

	<parameterMap type="map" id="mailStarUpdateParam">
		<parameter property="msgaddAdsee" javaType="string" jdbcType="VARCHAR" 
			mode="IN"/>
		<parameter property="emptyFlag" javaType="string" jdbcType="VARCHAR" 
			mode="IN"/>
		<parameter property="msgaddNo" javaType="string" jdbcType="VARCHAR" 
			mode="IN"/>	
	</parameterMap>
	
	<update id="updateStarFlag" parameterMap="mailStarUpdateParam">
		call updateStarFlag(?,?,?)
	</update>
</mapper>